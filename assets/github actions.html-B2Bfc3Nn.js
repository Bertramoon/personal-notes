import{_ as c,c as l,a as p,b as a,d as s,e,r as o,o as i}from"./app-2MiBgEQI.js";const u="/assets/image-20250824172636930-CzHUjJv7.png",k="/assets/image-20250824172810568-lRW_o3LS.png",r="/assets/image-20250824173222505-DAbeepJX.png",d="/assets/image-20250824173406098-C-vVhbBK.png",m="/assets/image-20250824175404738-QPWGDvdR.png",v="/assets/image-20250824175501792-DBnrnn1n.png",b="/assets/image-20250824180027665-C3OEIttf.png",g="/assets/image-20250824180650059-yD-zhFz1.png",y="/assets/image-20250824181355636-ecGA8qWu.png",f="/assets/image-20251122002415894-GSsf7cWq.png",S="/assets/image-20251122002517945-yPiEgG6e.png",h="/assets/image-20251121234821130-DGa_-FF_.png",w="/assets/image-20251121234728119-C_SNPRu8.png",q="/assets/image-20251121234615187-oQ_Jp4Rf.png",R={},$={href:"https://semgrep.dev/signup",target:"_blank",rel:"noopener noreferrer"},E={href:"https://docs.github.com/zh/actions",target:"_blank",rel:"noopener noreferrer"},L={href:"https://semgrep.dev/docs/writing-rules/data-flow/taint-mode/advanced#taint-sanitizers-by-side-effect",target:"_blank",rel:"noopener noreferrer"};function A(_,n){const t=o("ExternalLinkIcon");return i(),l("div",null,[n[12]||(n[12]=p('<h1 id="目的" tabindex="-1"><a class="header-anchor" href="#目的"><span>目的</span></a></h1><p>使用GitHub Actions搭建一条DevSecOps持续交付流水线，实现自动集成、静态代码扫描（包括安全扫描）、单元测试、自动化部署等能力，用以保障快速开发场景的快速运维和代码安全</p><h1 id="需求" tabindex="-1"><a class="header-anchor" href="#需求"><span>需求</span></a></h1><ul><li>在代码合入dev分支时进行增量代码安全扫描，在代码合入master分支时进行全量代码安全扫描</li><li>扫描结果中，对于误报项可以进行手工分析和屏蔽</li><li>存在未处理项的分支不能合入master分支</li></ul><h1 id="入门" tabindex="-1"><a class="header-anchor" href="#入门"><span>入门</span></a></h1><p>https://docs.github.com/zh/actions</p><h1 id="semgrep" tabindex="-1"><a class="header-anchor" href="#semgrep"><span>Semgrep</span></a></h1><p>对于Semgrep就不多赘述了，这是一个SAST工具，用于多种语言的静态代码扫描，更多信息可参考官方：https://semgrep.dev</p><p>本文主要讲述如何在GitHub Actions上集成Semgrep</p><h2 id="【semgrep-01】在github-actions上集成semgrep" tabindex="-1"><a class="header-anchor" href="#【semgrep-01】在github-actions上集成semgrep"><span>【Semgrep 01】在GitHub Actions上集成Semgrep</span></a></h2><h3 id="_0-前言" tabindex="-1"><a class="header-anchor" href="#_0-前言"><span>0. 前言</span></a></h3><p>本文属于基础讲解，如果不熟悉Github Actions和Semgrep也没有关系，按照步骤来就可以</p><p>Github Actions：https://docs.github.com/zh/actions</p><p>Semgrep：https://semgrep.dev</p><p>Semgrep AppSec Platform：https://semgrep.dev/signup</p><h3 id="_1-准备github项目" tabindex="-1"><a class="header-anchor" href="#_1-准备github项目"><span>1. 准备Github项目</span></a></h3><p>在Github上随意一个项目即可：https://github.com/new</p><h3 id="_2-创建semgrep-token" tabindex="-1"><a class="header-anchor" href="#_2-创建semgrep-token"><span>2. 创建Semgrep Token</span></a></h3><p>在Github Actions中集成Semgrep时，需要使用到Semgrep Token。</p>',19)),a("p",null,[n[1]||(n[1]=s("1、首先，登录",-1)),a("a",$,[n[0]||(n[0]=s("Semgrep AppSec Platform",-1)),e(t)])]),n[13]||(n[13]=p('<p>2、来到<code>Settings</code>-&gt;<code>Tokens</code>-&gt;<code>API tokens</code>，点击<code>Create new token</code></p><p><img src="'+u+'" alt="image-20250824172636930"></p><p>3、Token scopes选择<code>Agent(CI)</code>即可；Name自定义即可；记得把<code>Secrets value</code>复制出来，需要注意该值只能在创建时才能看到，后续就无法看到和使用了，只能创建新的Token</p><p><img src="'+k+'" alt="image-20250824172810568"></p><h3 id="_3-在github项目secret中设置semgrep-token" tabindex="-1"><a class="header-anchor" href="#_3-在github项目secret中设置semgrep-token"><span>3. 在Github项目Secret中设置Semgrep token</span></a></h3><p>在GitHub项目中点击<code>Settings</code>-&gt;<code>Secrets and variables</code>-&gt;<code>Actions</code>-&gt;<code>New repository secret</code>创建代码仓库的Secret</p><p><img src="'+r+'" alt="image-20250824173222505"></p><p>Semgrep token命名为<code>SEMGREP_APP_TOKEN</code>（可以自定义），将第2步中创建的Semgrep Token值填入Secret中，并保存</p><p><img src="'+d+'" alt="image-20250824173406098"></p><h3 id="_4-创建github-actions工作流" tabindex="-1"><a class="header-anchor" href="#_4-创建github-actions工作流"><span>4. 创建Github Actions工作流</span></a></h3><p>在项目根目录下创建<code>.github/workflows/semgrep.yml</code>文件</p>',11)),a("p",null,[n[3]||(n[3]=s("下面这个工作流是从Semgrep官网上拿下来的，做了少量修改。这里简单解释一下，若还不清楚，可以参考",-1)),a("a",E,[n[2]||(n[2]=s("Github Actions",-1)),e(t)]),n[4]||(n[4]=s("做进一步学习",-1))]),n[14]||(n[14]=p(`<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">name</span><span class="token punctuation">:</span> Semgrep</span>
<span class="line"><span class="token key atrule">on</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># 发生pull request时触发扫描</span></span>
<span class="line">  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment"># 允许在GitHub Actions页面下手动点击触发</span></span>
<span class="line">  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment"># 在以下分支push代码时触发</span></span>
<span class="line">  <span class="token key atrule">push</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">branches</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> main</span>
<span class="line">      <span class="token punctuation">-</span> master</span>
<span class="line">      <span class="token punctuation">-</span> dev</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">permissions</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># 用于查看扫描结果和推送扫描报告到Github Security</span></span>
<span class="line">  <span class="token key atrule">security-events</span><span class="token punctuation">:</span> write</span>
<span class="line">  <span class="token key atrule">contents</span><span class="token punctuation">:</span> read</span>
<span class="line">  <span class="token key atrule">actions</span><span class="token punctuation">:</span> read</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">jobs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">semgrep</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># GitHub Actions job</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> semgrep/ci</span>
<span class="line">    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">container</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment"># 使用semgrep官方的容器，自带相关环境</span></span>
<span class="line">      <span class="token key atrule">image</span><span class="token punctuation">:</span> semgrep/semgrep</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 跳过机器人创建的PR等操作，避免越权或无意义扫描</span></span>
<span class="line">    <span class="token key atrule">if</span><span class="token punctuation">:</span> (github.actor <span class="token tag">!=</span> &#39;dependabot<span class="token punctuation">[</span>bot<span class="token punctuation">]</span>&#39;)</span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">steps</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment"># Github Actions标准的checkout，用于检出代码，无需关心</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4</span>
<span class="line">      <span class="token comment"># 关键地方</span></span>
<span class="line">      <span class="token comment"># semgrep ci：使用CI的方式启动semgrep扫描，会使用到默认的社区版+pro版的规则集</span></span>
<span class="line">      <span class="token comment"># --pro：会启动pro模式，该模式下才能实现污点分析的跨文件扫描。例如controller层的用户输入在service层进行了SQL拼接导致SQL注入，开启pro模式才能扫描出来</span></span>
<span class="line">      <span class="token comment"># --sarif：输出sarif格式的扫描报告</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> semgrep ci <span class="token punctuation">-</span><span class="token punctuation">-</span>pro <span class="token punctuation">-</span><span class="token punctuation">-</span>sarif <span class="token punctuation">&gt;</span> semgrep.sarif</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment"># 此处就是在第3步中设置的Secret，如果自定义了名称，将&quot;SEMGREP_APP_TOKEN&quot;修改为自定义的名称即可</span></span>
<span class="line">          <span class="token key atrule">SEMGREP_APP_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.SEMGREP_APP_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment"># 上传sarif扫描报告到Github Security中</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload SARIF file for GitHub Advanced Security Dashboard</span>
<span class="line">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> github/codeql<span class="token punctuation">-</span>action/upload<span class="token punctuation">-</span>sarif@v3</span>
<span class="line">        <span class="token key atrule">with</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">sarif_file</span><span class="token punctuation">:</span> semgrep.sarif</span>
<span class="line">        <span class="token key atrule">if</span><span class="token punctuation">:</span> always()</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-启动扫描" tabindex="-1"><a class="header-anchor" href="#_5-启动扫描"><span>5. 启动扫描</span></a></h3><p>可以添加一些存在漏洞的测试代码，然后push到项目中，工作流会自动开启扫描。下面给出基于Springboot的测试代码，你也可以自己编写测试代码：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>sqli<span class="token punctuation">.</span></span><span class="token class-name">SQLiRequest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sqli&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUrl<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUsername<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.password}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbPassword<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-bad-1&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcBad1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 获取JDBC连接并执行SQL查询</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 执行SQL查询</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = \\&quot;&quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\\&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Statement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 处理查询结果</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 从结果集中获取数据</span></span>
<span class="line">                    <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-bad-2&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcBad2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 获取JDBC连接并执行SQL查询</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 执行SQL查询</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 处理查询结果</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token comment">// 从结果集中获取数据</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-在github-security中查看扫描结果" tabindex="-1"><a class="header-anchor" href="#_6-在github-security中查看扫描结果"><span>6. 在Github Security中查看扫描结果</span></a></h3><p><img src="`+m+'" alt="image-20250824175404738"></p><p><img src="'+v+'" alt="image-20250824175501792"></p><h3 id="_7-在semgrep-appsec-platform中查看扫描结果" tabindex="-1"><a class="header-anchor" href="#_7-在semgrep-appsec-platform中查看扫描结果"><span>7. 在Semgrep AppSec Platform中查看扫描结果</span></a></h3><p>Semgrep AppSec Platform提供了更丰富的查询，并且每次扫描时会将最新结果同步到Github Security中，更加方便</p><p><img src="'+b+'" alt="image-20250824180027665"></p><p><img src="'+g+'" alt="image-20250824180650059"></p><p>如果开启了AI辅助模式，还能给出修复建议：</p><p><img src="'+y+`" alt="image-20250824181355636"></p><h2 id="【semgrep-02】以小见大-如何改写和自定义规则" tabindex="-1"><a class="header-anchor" href="#【semgrep-02】以小见大-如何改写和自定义规则"><span>【Semgrep 02】以小见大，如何改写和自定义规则</span></a></h2><p>在我们使用Semgrep进行扫描的时候，会发现存在误报，或者有些问题它扫描不了，没有对应的规则。也就是说，根据公司和项目的风格习惯和编码规范等，我们需要对规则进行改写和自定义。</p><p>既然是写规则，那让我们先从开发安全规则角度出发，看看问题可以怎么分类：</p><ul><li><strong>特征关键词匹配</strong>。常见于不安全函数的使用</li><li><strong>通用编码问题</strong>。使用污点分析的方式跟踪输入源(source)及中间过程直到汇点(sink)，常用于命令注入、SQL注入等漏洞</li><li><strong>自研代码编码问题</strong>。属于当前系统或当前系统所对接的其他私有项目的问题，需要专门编写规则用以适配当前系统代码，常见于访问控制、不安全配置项等</li></ul><p>对于前两类问题，工具的默认规则基本上涵盖了大部分的问题识别。但是存在一个问题，就是如果我们的校验方法不是使用业界最标准的措施的话（例如自定义了一个白名单规则校验，而不是使用更安全的三方库），那么默认规则肯定是无法识别到这些自定义的校验方法的，就会导致存在误报。此时，如果这个校验方法在我们的代码里是“通用”的，很多项目中都使用到了，那么我们可以通过<strong>改写规则</strong>，加入“消毒”方法使其不会产生误报。</p><p>对于最后的自研代码编码问题，我们需要完全<strong>自定义规则</strong>。</p><p>而Semgrep作为一款扩展性强的工具，自然是可以改写和自定义规则的。下面，以SQL注入为例，分别进行规则改写和自定义编写。</p><h3 id="改写现有规则降低误报率" tabindex="-1"><a class="header-anchor" href="#改写现有规则降低误报率"><span>改写现有规则降低误报率</span></a></h3><p><code>tainted-sql-string</code>是Semgrep社区的SQL注入扫描规则，详细如下（仅保留规则核心配置，其他无关信息进行了删减），它使用污点分析模式进行匹配。</p><ul><li>pattern-sources指定了污染源是接口上用户的输入，并且将Integer、Long等类型排除在外</li><li>pattern-sinks指定了SQL拼接的情况，并将控制台输出、日志打印、抛出错误等情况进行排除</li></ul><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_unify_mvars</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                    $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                    ...</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += $TAINTED_KEY</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在有这样一段代码，有<code>/jdbc-bad</code>和<code>/jdbc-good</code>两个接口：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SQLiService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>sqli<span class="token punctuation">.</span></span><span class="token class-name">SQLiRequest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sqli&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUrl<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUsername<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.password}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbPassword<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-bad&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcBad</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 存在SQL拼接用户输入，不安全</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-good&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcGood</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 检查字段名是否在User类的属性中，所以是安全的</span></span>
<span class="line">                    <span class="token function">checkFieldName</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;字段名不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口<code>/jdbc-bad</code>使用外部输入作为表名拼接到SQL语句中，存在SQL注入。接口<code>/jdbc-good</code>在使用外部输入作为表名拼接SQL前，调用<code>checkFieldName</code>进行了校验，因为不会存在SQL注入问题。然而，在使用<code>tainted-sql-string</code>规则进行检查时，会发现两条规则都会匹配命中。那么如果我们希望减少误报率，该怎么做呢？其实也很简单，Semgrep提供了pattern-sanitizers用于指定消毒规则。我们只需要加上如下规则即可：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">    <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,28)),a("p",null,[n[6]||(n[6]=s("规则表示当调用",-1)),n[7]||(n[7]=a("code",null,"checkFieldName",-1)),n[8]||(n[8]=s("对污染源进行消毒时，之后的访问都是安全的，pattern-sinks将不会触发。",-1)),n[9]||(n[9]=a("code",null,"by-side-effect",-1)),n[10]||(n[10]=s("的作用可以参考",-1)),a("a",L,[n[5]||(n[5]=s("官方文档",-1)),e(t)]),n[11]||(n[11]=s("，按照官方解释来说就是是否受到函数“副作用”的影响，这个所谓“副作用”指的是处理过程（如函数）是否对入参本身造成影响。简单来说就是：",-1))]),n[15]||(n[15]=p(`<ul><li><code>by-side-effect: false</code>（默认）：处理过程不会对输入对象造成影响，只会对返回已经“消毒”的结果。例如<code>result = sanitizers(source)</code>，source不会发生变化，还是未经消毒的输入源，而result是经过消毒、可以信任的处理数据</li><li><code>by-side-effect: only</code>：处理过程只会对输入对象进行“消毒”，不会对返回结果造成影响。例如<code>result = sanitizers(source)</code>，result不会进行消毒，但source是经过消毒的、可以信任的处理数据</li><li><code>by-side-effect: true</code>：处理过程既对输入对象“消毒”，也对返回的结果“消毒”。例如<code>result = sanitizers(source)</code>，result和source是经过消毒的，可以信任的数据</li></ul><p>就像下面这个例子：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">source <span class="token operator">=</span> userInput</span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: true</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: false</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: only</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，我们得到的完整规则如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string<span class="token punctuation">-</span>custom</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> ERROR</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> 自定义的spring SQL注入扫描(源自tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string)<span class="token punctuation">-</span>V1</span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cwe</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> &quot;CWE<span class="token punctuation">-</span><span class="token key atrule">89</span><span class="token punctuation">:</span> Improper Neutralization of Special Elements used in an SQL</span>
<span class="line">          Command (&#39;SQL Injection&#39;)&quot;</span>
<span class="line">      <span class="token key atrule">owasp</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> A01<span class="token punctuation">:</span>2017 <span class="token punctuation">-</span> Injection</span>
<span class="line">        <span class="token punctuation">-</span> A03<span class="token punctuation">:</span>2021 <span class="token punctuation">-</span> Injection</span>
<span class="line">      <span class="token key atrule">references</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html</span>
<span class="line">      <span class="token key atrule">category</span><span class="token punctuation">:</span> security</span>
<span class="line">      <span class="token key atrule">technology</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> spring</span>
<span class="line">      <span class="token key atrule">cwe2022-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">cwe2021-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">subcategory</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> vuln</span>
<span class="line">      <span class="token key atrule">likelihood</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">      <span class="token key atrule">impact</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">confidence</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">license</span><span class="token punctuation">:</span> Semgrep Rules License v1.0. For more details<span class="token punctuation">,</span> visit</span>
<span class="line">        semgrep.dev/legal/rules<span class="token punctuation">-</span>license</span>
<span class="line">      <span class="token key atrule">vulnerability_class</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> SQL Injection</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_numbers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_booleans</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">        <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot; + ...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot;.concat(...)</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      StringBuilder $SB = new StringBuilder(&quot;$SQLSTR&quot;);</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $SB.append(<span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += <span class="token punctuation">...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format(&quot;$SQLSTR&quot;<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      String $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format($VAR<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>扫描结果如下，位于169行的该漏洞点消失了</p><p><img src="`+f+'" alt="image-20251122002415894"></p><p><img src="'+S+`" alt="image-20251122002517945"></p><h3 id="自定义规则实现漏洞扫描" tabindex="-1"><a class="header-anchor" href="#自定义规则实现漏洞扫描"><span>自定义规则实现漏洞扫描</span></a></h3><p>Semgrep没有针对Mybatis的SQL注入校验规则，需要我们自行编写，分别用于注解方式和XML配置文件方式的情况下检测SQL注入问题。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>annotation</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using annotation</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">              $RET $METHODNAME(..., @Param(&quot;$PARAM&quot;) $TYPE $_, ...);</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., $TYPE $PARAM, ...);</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-not</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., @$ANNOTATION(...) $TYPE $PARAM, ...);</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $OPERATION</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>update<span class="token punctuation">|</span>delete)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(^(<span class="token punctuation">?</span><span class="token tag">!.*short</span><span class="token punctuation">|</span>int<span class="token punctuation">|</span>integer<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>boolean).<span class="token important">*$)</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-comparison</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">comparison</span><span class="token punctuation">:</span> str($PARAM) in str($SQL)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>xml</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using XML</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> xml</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;select&gt;$...KEY&lt;/select&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;insert&gt;$...KEY&lt;/insert&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;update&gt;$...KEY&lt;/update&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;delete&gt;$...KEY&lt;/delete&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;sql&gt;$...KEY&lt;/sql&gt;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $<span class="token punctuation">...</span>KEY</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里规则写得比较简单（存在优化空间），当SQL语句注解中或者XML的SQL语句配置中出现了&quot;\${...}&quot;，就认为存在SQL注入。扫描结果如下。</p><p>注解方式：</p><p><img src="`+h+'" alt="image-20251121234821130"></p><p>XML文件：</p><p><img src="'+w+'" alt="image-20251121234728119"></p><p>如果使用AppSec Platform查看，还能看到AI智能修复建议：</p><p><img src="'+q+'" alt="image-20251121234615187"></p>',18))])}const M=c(R,[["render",A]]),Q=JSON.parse('{"path":"/series/security_test/SAST/github actions.html","title":"Github Actions","lang":"zh-CN","frontmatter":{"title":"Github Actions","date":"2022-8-28"},"headers":[{"level":2,"title":"【Semgrep 01】在GitHub Actions上集成Semgrep","slug":"【semgrep-01】在github-actions上集成semgrep","link":"#【semgrep-01】在github-actions上集成semgrep","children":[{"level":3,"title":"0. 前言","slug":"_0-前言","link":"#_0-前言","children":[]},{"level":3,"title":"1. 准备Github项目","slug":"_1-准备github项目","link":"#_1-准备github项目","children":[]},{"level":3,"title":"2. 创建Semgrep Token","slug":"_2-创建semgrep-token","link":"#_2-创建semgrep-token","children":[]},{"level":3,"title":"3. 在Github项目Secret中设置Semgrep token","slug":"_3-在github项目secret中设置semgrep-token","link":"#_3-在github项目secret中设置semgrep-token","children":[]},{"level":3,"title":"4. 创建Github Actions工作流","slug":"_4-创建github-actions工作流","link":"#_4-创建github-actions工作流","children":[]},{"level":3,"title":"5. 启动扫描","slug":"_5-启动扫描","link":"#_5-启动扫描","children":[]},{"level":3,"title":"6. 在Github Security中查看扫描结果","slug":"_6-在github-security中查看扫描结果","link":"#_6-在github-security中查看扫描结果","children":[]},{"level":3,"title":"7. 在Semgrep AppSec Platform中查看扫描结果","slug":"_7-在semgrep-appsec-platform中查看扫描结果","link":"#_7-在semgrep-appsec-platform中查看扫描结果","children":[]}]},{"level":2,"title":"【Semgrep 02】以小见大，如何改写和自定义规则","slug":"【semgrep-02】以小见大-如何改写和自定义规则","link":"#【semgrep-02】以小见大-如何改写和自定义规则","children":[{"level":3,"title":"改写现有规则降低误报率","slug":"改写现有规则降低误报率","link":"#改写现有规则降低误报率","children":[]},{"level":3,"title":"自定义规则实现漏洞扫描","slug":"自定义规则实现漏洞扫描","link":"#自定义规则实现漏洞扫描","children":[]}]}],"git":{"createdTime":1764485360000,"updatedTime":1764485360000,"contributors":[{"name":"bertramoon","email":"bertramoon@126.com","commits":1}]},"filePathRelative":"series/security_test/SAST/github actions.md"}');export{M as comp,Q as data};
