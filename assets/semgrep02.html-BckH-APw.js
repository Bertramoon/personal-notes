import{_ as e,c as l,a as p,b as a,d as s,e as c,r as o,o as i}from"./app-2MiBgEQI.js";const u="/assets/image-20251122002415894-GSsf7cWq.png",k="/assets/image-20251122002517945-yPiEgG6e.png",r="/assets/image-20251121234821130-DGa_-FF_.png",d="/assets/image-20251121234728119-C_SNPRu8.png",v="/assets/image-20251121234615187-oQ_Jp4Rf.png",m={},b={href:"https://semgrep.dev/docs/writing-rules/data-flow/taint-mode/advanced#taint-sanitizers-by-side-effect",target:"_blank",rel:"noopener noreferrer"};function y(g,n){const t=o("ExternalLinkIcon");return i(),l("div",null,[n[7]||(n[7]=p(`<p>在我们使用Semgrep进行扫描的时候，会发现存在误报，或者有些问题它扫描不了，没有对应的规则。也就是说，根据公司和项目的风格习惯和编码规范等，我们需要对规则进行改写和自定义。</p><p>既然是写规则，那让我们先从开发安全规则角度出发，看看问题可以怎么分类：</p><ul><li><strong>特征关键词匹配</strong>。常见于不安全函数的使用</li><li><strong>通用编码问题</strong>。使用污点分析的方式跟踪输入源(source)及中间过程直到汇点(sink)，常用于命令注入、SQL注入等漏洞</li><li><strong>自研代码编码问题</strong>。属于当前系统或当前系统所对接的其他私有项目的问题，需要专门编写规则用以适配当前系统代码，常见于访问控制、不安全配置项等</li></ul><p>对于前两类问题，工具的默认规则基本上涵盖了大部分的问题识别。但是存在一个问题，就是如果我们的校验方法不是使用业界最标准的措施的话（例如自定义了一个白名单规则校验，而不是使用更安全的三方库），那么默认规则肯定是无法识别到这些自定义的校验方法的，就会导致存在误报。此时，如果这个校验方法在我们的代码里是“通用”的，很多项目中都使用到了，那么我们可以通过<strong>改写规则</strong>，加入“消毒”方法使其不会产生误报。</p><p>对于最后的自研代码编码问题，我们需要完全<strong>自定义规则</strong>。</p><p>而Semgrep作为一款扩展性强的工具，自然是可以改写和自定义规则的。下面，以SQL注入为例，分别进行规则改写和自定义编写。</p><h3 id="改写现有规则降低误报率" tabindex="-1"><a class="header-anchor" href="#改写现有规则降低误报率"><span>改写现有规则降低误报率</span></a></h3><p><code>tainted-sql-string</code>是Semgrep社区的SQL注入扫描规则，详细如下（仅保留规则核心配置，其他无关信息进行了删减），它使用污点分析模式进行匹配。</p><ul><li>pattern-sources指定了污染源是接口上用户的输入，并且将Integer、Long等类型排除在外</li><li>pattern-sinks指定了SQL拼接的情况，并将控制台输出、日志打印、抛出错误等情况进行排除</li></ul><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_unify_mvars</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                    $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                    ...</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += $TAINTED_KEY</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在有这样一段代码，有<code>/jdbc-bad</code>和<code>/jdbc-good</code>两个接口：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SQLiService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>sqli<span class="token punctuation">.</span></span><span class="token class-name">SQLiRequest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sqli&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUrl<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUsername<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.datasource.password}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbPassword<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-bad&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcBad</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 存在SQL拼接用户输入，不安全</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-good&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcGood</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 检查字段名是否在User类的属性中，所以是安全的</span></span>
<span class="line">                    <span class="token function">checkFieldName</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;字段名不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口<code>/jdbc-bad</code>使用外部输入作为表名拼接到SQL语句中，存在SQL注入。接口<code>/jdbc-good</code>在使用外部输入作为表名拼接SQL前，调用<code>checkFieldName</code>进行了校验，因为不会存在SQL注入问题。然而，在使用<code>tainted-sql-string</code>规则进行检查时，会发现两条规则都会匹配命中。那么如果我们希望减少误报率，该怎么做呢？其实也很简单，Semgrep提供了pattern-sanitizers用于指定消毒规则。我们只需要加上如下规则即可：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">    <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14)),a("p",null,[n[1]||(n[1]=s("规则表示当调用",-1)),n[2]||(n[2]=a("code",null,"checkFieldName",-1)),n[3]||(n[3]=s("对污染源进行消毒时，之后的访问都是安全的，pattern-sinks将不会触发。",-1)),n[4]||(n[4]=a("code",null,"by-side-effect",-1)),n[5]||(n[5]=s("的作用可以参考",-1)),a("a",b,[n[0]||(n[0]=s("官方文档",-1)),c(t)]),n[6]||(n[6]=s("，按照官方解释来说就是是否受到函数“副作用”的影响，这个所谓“副作用”指的是处理过程（如函数）是否对入参本身造成影响。简单来说就是：",-1))]),n[8]||(n[8]=p(`<ul><li><code>by-side-effect: false</code>（默认）：处理过程不会对输入对象造成影响，只会对返回已经“消毒”的结果。例如<code>result = sanitizers(source)</code>，source不会发生变化，还是未经消毒的输入源，而result是经过消毒、可以信任的处理数据</li><li><code>by-side-effect: only</code>：处理过程只会对输入对象进行“消毒”，不会对返回结果造成影响。例如<code>result = sanitizers(source)</code>，result不会进行消毒，但source是经过消毒的、可以信任的处理数据</li><li><code>by-side-effect: true</code>：处理过程既对输入对象“消毒”，也对返回的结果“消毒”。例如<code>result = sanitizers(source)</code>，result和source是经过消毒的，可以信任的数据</li></ul><p>就像下面这个例子：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">source <span class="token operator">=</span> userInput</span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: true</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: false</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: only</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，我们得到的完整规则如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string<span class="token punctuation">-</span>custom</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> ERROR</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> 自定义的spring SQL注入扫描(源自tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string)<span class="token punctuation">-</span>V1</span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cwe</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> &quot;CWE<span class="token punctuation">-</span><span class="token key atrule">89</span><span class="token punctuation">:</span> Improper Neutralization of Special Elements used in an SQL</span>
<span class="line">          Command (&#39;SQL Injection&#39;)&quot;</span>
<span class="line">      <span class="token key atrule">owasp</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> A01<span class="token punctuation">:</span>2017 <span class="token punctuation">-</span> Injection</span>
<span class="line">        <span class="token punctuation">-</span> A03<span class="token punctuation">:</span>2021 <span class="token punctuation">-</span> Injection</span>
<span class="line">      <span class="token key atrule">references</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html</span>
<span class="line">      <span class="token key atrule">category</span><span class="token punctuation">:</span> security</span>
<span class="line">      <span class="token key atrule">technology</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> spring</span>
<span class="line">      <span class="token key atrule">cwe2022-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">cwe2021-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">subcategory</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> vuln</span>
<span class="line">      <span class="token key atrule">likelihood</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">      <span class="token key atrule">impact</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">confidence</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">license</span><span class="token punctuation">:</span> Semgrep Rules License v1.0. For more details<span class="token punctuation">,</span> visit</span>
<span class="line">        semgrep.dev/legal/rules<span class="token punctuation">-</span>license</span>
<span class="line">      <span class="token key atrule">vulnerability_class</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> SQL Injection</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_numbers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_booleans</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">        <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot; + ...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot;.concat(...)</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      StringBuilder $SB = new StringBuilder(&quot;$SQLSTR&quot;);</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $SB.append(<span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += <span class="token punctuation">...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format(&quot;$SQLSTR&quot;<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      String $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format($VAR<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>扫描结果如下，位于169行的该漏洞点消失了</p><p><img src="`+u+'" alt="image-20251122002415894"></p><p><img src="'+k+`" alt="image-20251122002517945"></p><h3 id="自定义规则实现漏洞扫描" tabindex="-1"><a class="header-anchor" href="#自定义规则实现漏洞扫描"><span>自定义规则实现漏洞扫描</span></a></h3><p>Semgrep没有针对Mybatis的SQL注入校验规则，需要我们自行编写，分别用于注解方式和XML配置文件方式的情况下检测SQL注入问题。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>annotation</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using annotation</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">              $RET $METHODNAME(..., @Param(&quot;$PARAM&quot;) $TYPE $_, ...);</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., $TYPE $PARAM, ...);</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-not</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., @$ANNOTATION(...) $TYPE $PARAM, ...);</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $OPERATION</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>update<span class="token punctuation">|</span>delete)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(^(<span class="token punctuation">?</span><span class="token tag">!.*short</span><span class="token punctuation">|</span>int<span class="token punctuation">|</span>integer<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>boolean).<span class="token important">*$)</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-comparison</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">comparison</span><span class="token punctuation">:</span> str($PARAM) in str($SQL)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>xml</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using XML</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> xml</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;select&gt;$...KEY&lt;/select&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;insert&gt;$...KEY&lt;/insert&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;update&gt;$...KEY&lt;/update&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;delete&gt;$...KEY&lt;/delete&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;sql&gt;$...KEY&lt;/sql&gt;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $<span class="token punctuation">...</span>KEY</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里规则写得比较简单（存在优化空间），当SQL语句注解中或者XML的SQL语句配置中出现了&quot;\${...}&quot;，就认为存在SQL注入。扫描结果如下。</p><p>注解方式：</p><p><img src="`+r+'" alt="image-20251121234821130"></p><p>XML文件：</p><p><img src="'+d+'" alt="image-20251121234728119"></p><p>如果使用AppSec Platform查看，还能看到AI智能修复建议：</p><p><img src="'+v+'" alt="image-20251121234615187"></p>',18))])}const S=e(m,[["render",y]]),$=JSON.parse('{"path":"/series/sdl/SAST/Semgrep/semgrep02.html","title":"02 以小见大，如何改写和自定义规则","lang":"zh-CN","frontmatter":{"title":"02 以小见大，如何改写和自定义规则","date":"2025-11-22"},"headers":[{"level":3,"title":"改写现有规则降低误报率","slug":"改写现有规则降低误报率","link":"#改写现有规则降低误报率","children":[]},{"level":3,"title":"自定义规则实现漏洞扫描","slug":"自定义规则实现漏洞扫描","link":"#自定义规则实现漏洞扫描","children":[]}],"git":{"createdTime":1764485360000,"updatedTime":1764485360000,"contributors":[{"name":"bertramoon","email":"bertramoon@126.com","commits":1}]},"filePathRelative":"series/sdl/SAST/Semgrep/semgrep02.md"}');export{S as comp,$ as data};
