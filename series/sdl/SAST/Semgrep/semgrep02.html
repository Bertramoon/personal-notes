<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>02 以小见大，如何改写和自定义规则 | Bertram的云笔记</title><meta name="description" content="个人云笔记，记录个人学习和工作中的一些知识和感悟">
    <link rel="preload" href="/assets/style-DRXNKcOj.css" as="style"><link rel="stylesheet" href="/assets/style-DRXNKcOj.css">
    <link rel="modulepreload" href="/assets/app-2MiBgEQI.js"><link rel="modulepreload" href="/assets/semgrep02.html-BckH-APw.js">
    <link rel="prefetch" href="/assets/timeline.html-CZ5Yjp1P.js" as="script"><link rel="prefetch" href="/assets/posts.html-DxDqQDts.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-DfcsxTmd.js" as="script"><link rel="prefetch" href="/assets/1.html-BaMcZ_5J.js" as="script"><link rel="prefetch" href="/assets/1.html-BaljAl6_.js" as="script"><link rel="prefetch" href="/assets/1.html-ChmIFiM1.js" as="script"><link rel="prefetch" href="/assets/1.html-Od33o070.js" as="script"><link rel="prefetch" href="/assets/1.html-CDN60vIV.js" as="script"><link rel="prefetch" href="/assets/1.html-CN7lK1lD.js" as="script"><link rel="prefetch" href="/assets/1.html-BnCMPKw9.js" as="script"><link rel="prefetch" href="/assets/index.html-FruAxReY.js" as="script"><link rel="prefetch" href="/assets/deep_and_shallow_copy.html-DQigBswD.js" as="script"><link rel="prefetch" href="/assets/sslerror.html-BVslH-Ur.js" as="script"><link rel="prefetch" href="/assets/index.html-e3HNw6ki.js" as="script"><link rel="prefetch" href="/assets/index.html-BoKCqAw8.js" as="script"><link rel="prefetch" href="/assets/index.html-BDAT0yTD.js" as="script"><link rel="prefetch" href="/assets/database paradigm.html-B7fZtaa4.js" as="script"><link rel="prefetch" href="/assets/index.html-CgGkBimb.js" as="script"><link rel="prefetch" href="/assets/index.html-DXq2z30o.js" as="script"><link rel="prefetch" href="/assets/log_injection.html-DnrQ8RgN.js" as="script"><link rel="prefetch" href="/assets/github actions.html-B2Bfc3Nn.js" as="script"><link rel="prefetch" href="/assets/index.html-CeEymxQg.js" as="script"><link rel="prefetch" href="/assets/semgrep01.html-_u3TeTCp.js" as="script"><link rel="prefetch" href="/assets/404.html-D_jbJ5ye.js" as="script"><link rel="prefetch" href="/assets/Valine.min-_LyT3bfY.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/assets/IconBlog-BShuyPYA.js" as="script"><link rel="prefetch" href="/assets/IconCycle-A7weMzkA.js" as="script"><link rel="prefetch" href="/assets/IconDesign-CtsPmx93.js" as="script"><link rel="prefetch" href="/assets/IconDev-BsWtAPWS.js" as="script"><link rel="prefetch" href="/assets/IconFriendship-Dd9hYIrf.js" as="script"><link rel="prefetch" href="/assets/IconGithub-CqeO7Pt3.js" as="script"><link rel="prefetch" href="/assets/IconHome-Bav6m9VO.js" as="script"><link rel="prefetch" href="/assets/IconNote-uCyunHMD.js" as="script"><link rel="prefetch" href="/assets/IconSecurity-BDHJnrFy.js" as="script"><link rel="prefetch" href="/assets/IconTimeline-BLZPCj6u.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container show-series show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/head.jpg" alt="Bertram的云笔记"><a href="/" class="site-name can-hide">Bertram的云笔记</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="主页"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16.612 2.214a1.01 1.01 0 0 0-1.242 0L1 13.419l1.243 1.572L4 13.621V26a2.004 2.004 0 0 0 2 2h20a2.004 2.004 0 0 0 2-2V13.63L29.757 15L31 13.428zM18 26h-4v-8h4zm2 0v-8a2.002 2.002 0 0 0-2-2h-4a2.002 2.002 0 0 0-2 2v8H6V12.062l10-7.79l10 7.8V26z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->主页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="xicon-container left title"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->分类<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->分类<!--]--></span></span></span><span class="right arrow"></span></button><ul class="dropdown-link__container" style="display:none;"><!--[--><li class="dropdown-link__item"><a href="/categories/ruanjianshejiyujiagou/shujukufanshi/1.html" class="link" aria-label="软件设计与架构/数据库范式"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->软件设计与架构/数据库范式<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Python/1.html" class="link" aria-label="Python"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Python<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="xicon-container left title"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->标签<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->标签<!--]--></span></span></span><span class="right arrow"></span></button><ul class="dropdown-link__container" style="display:none;"><!--[--><li class="dropdown-link__item"><a href="/tags/SQL/1.html" class="link" aria-label="SQL"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->SQL<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/pachong/1.html" class="link" aria-label="爬虫"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->爬虫<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/baocuo/1.html" class="link" aria-label="报错"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->报错<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/bianchengjichu/1.html" class="link" aria-label="编程基础"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->编程基础<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/posts" class="link" aria-label="博客"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;font-size:18px;color:;"><path d="M26 30H11a2.002 2.002 0 0 1-2-2v-6h2v6h15V6h-9V4h9a2.002 2.002 0 0 1 2 2v22a2.002 2.002 0 0 1-2 2z" fill="currentColor"></path><path d="M17 10h7v2h-7z" fill="currentColor"></path><path d="M16 15h8v2h-8z" fill="currentColor"></path><path d="M15 20h9v2h-9z" fill="currentColor"></path><path d="M9 19a5.005 5.005 0 0 1-5-5V3h2v11a3 3 0 0 0 6 0V5a1 1 0 0 0-2 0v10H8V5a3 3 0 0 1 6 0v9a5.005 5.005 0 0 1-5 5z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->博客<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title--active dropdown-link__title" type="button" aria-label="WIKI"><span class="xicon-container left title"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 4v16H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12z"></path><path d="M19 16H7a2 2 0 0 0-2 2"></path><path d="M9 8h6"></path></g></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->WIKI<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="WIKI"><span class="title"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 4v16H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12z"></path><path d="M19 16H7a2 2 0 0 0-2 2"></path><path d="M9 8h6"></path></g></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->WIKI<!--]--></span></span></span><span class="right arrow"></span></button><ul class="dropdown-link__container" style="display:none;"><!--[--><li class="dropdown-link__item"><a href="/series/security_architecture_design/" class="link" aria-label="安全架构与设计"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M20.97 7.27a.996.996 0 0 0 0-1.41l-2.83-2.83a.996.996 0 0 0-1.41 0l-4.49 4.49l-3.89-3.89c-.78-.78-2.05-.78-2.83 0l-1.9 1.9c-.78.78-.78 2.05 0 2.83l3.89 3.89L3 16.76V21h4.24l4.52-4.52l3.89 3.89c.95.95 2.23.6 2.83 0l1.9-1.9c.78-.78.78-2.05 0-2.83l-3.89-3.89l4.48-4.48zM5.04 6.94l1.89-1.9L8.2 6.31L7.02 7.5l1.41 1.41l1.19-1.19l1.2 1.2l-1.9 1.9l-3.88-3.88zm11.23 7.44l-1.19 1.19l1.41 1.41l1.19-1.19l1.27 1.27l-1.9 1.9l-3.89-3.89l1.9-1.9l1.21 1.21zM6.41 19H5v-1.41l9.61-9.61l1.3 1.3l.11.11L6.41 19zm9.61-12.44l1.41-1.41l1.41 1.41l-1.41 1.41l-1.41-1.41z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->安全架构与设计<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/series/security_code/" class="link" aria-label="安全编码"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 512 512" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M160 389a20.91 20.91 0 0 1-13.82-5.2l-128-112a21 21 0 0 1 0-31.6l128-112a21 21 0 0 1 27.66 31.61L63.89 256l109.94 96.19A21 21 0 0 1 160 389z" fill="currentColor"></path><path d="M352 389a21 21 0 0 1-13.84-36.81L448.11 256l-109.94-96.19a21 21 0 0 1 27.66-31.61l128 112a21 21 0 0 1 0 31.6l-128 112A20.89 20.89 0 0 1 352 389z" fill="currentColor"></path><path d="M208 437a21 21 0 0 1-20.12-27l96-320a21 21 0 1 1 40.23 12l-96 320A21 21 0 0 1 208 437z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->安全编码<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/series/security_test/" class="link" aria-label="安全测试"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12c5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->安全测试<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/series/sdl/" class="link" aria-label="安全开发生命周期"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17l-2 2l2 2m-2-2h9a2 2 0 0 0 1.75-2.75l-.55-1"></path><path d="M8.536 11l-.732-2.732L5.072 9m2.732-.732l-4.5 7.794a2 2 0 0 0 1.506 2.89l1.141.024"></path><path d="M15.464 11l2.732.732L18.928 9m-.732 2.732l-4.5-7.794a2 2 0 0 0-3.256-.14l-.591.976"></path></g></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->安全开发生命周期<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/timeline" class="link" aria-label="发布时间线"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><g fill="none"><path d="M15.25 13c.967 0 1.75.784 1.75 1.75v4.5A1.75 1.75 0 0 1 15.25 21H3.75A1.75 1.75 0 0 1 2 19.25v-4.5c0-.966.784-1.75 1.75-1.75h11.5zM21 14.899v5.351a.75.75 0 0 1-1.493.102l-.007-.102v-5.338a3.006 3.006 0 0 0 1.5-.013zm-5.75-.399H3.75a.25.25 0 0 0-.25.25v4.5c0 .138.112.25.25.25h11.5a.25.25 0 0 0 .25-.25v-4.5a.25.25 0 0 0-.25-.25zm5-4.408a1.908 1.908 0 1 1 0 3.816a1.908 1.908 0 0 1 0-3.816zM15.246 3c.967 0 1.75.784 1.75 1.75v4.5a1.75 1.75 0 0 1-1.75 1.75h-11.5a1.75 1.75 0 0 1-1.75-1.75v-4.5a1.75 1.75 0 0 1 1.607-1.744L3.746 3h11.5zm0 1.5h-11.5l-.057.007a.25.25 0 0 0-.193.243v4.5c0 .138.112.25.25.25h11.5a.25.25 0 0 0 .25-.25v-4.5a.25.25 0 0 0-.25-.25zM20.25 3a.75.75 0 0 1 .744.648L21 3.75v5.351a3.004 3.004 0 0 0-1.5-.013V3.75a.75.75 0 0 1 .75-.75z" fill="currentColor"></path></g></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->发布时间线<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/friendship-link" class="link" aria-label="友情链接"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M25 10H7a3.003 3.003 0 0 0-3 3v6a2.002 2.002 0 0 0 2 2v7a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2V16h-2v12H8v-9H6v-6a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v6h-2v9h-4V16h-2v12a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2v-7a2.002 2.002 0 0 0 2-2v-6a3.003 3.003 0 0 0-3-3z" fill="currentColor"></path><path d="M10 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path><path d="M22 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->友情链接<!--]--></span></span><!--[--><!--]--></a></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><header class="sub-navbar-container not-open"><span class="nav-item"><div class="toggle-series-button" aria-expanded="false" role="button" tabindex="0"><span></span><span></span><span></span></div> Series </span></header><!----><!----><div class="theme-main" style=""><aside class="series-container"><!--[--><!--[--><a href="/series/sdl/" class="link series-item series-item" aria-label="简介"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->简介<!--]--></span></span><!--[--><!--]--></a><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading series-level-1 active"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:16px;"><!--[-->SAST<!--]--></span></span><span class="arrow down"></span></h5><ul style="display:block;"><li><!--[--><a href="/series/sdl/SAST/" class="link series-item series-item" aria-label="简介"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->简介<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><section class="series-group series-item"><h6 class="series-heading series-level-2"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Semgrep<!--]--></span></span><!----></h6><ul style="display:block;"><li><!--[--><a href="/series/sdl/SAST/Semgrep/" class="link series-item series-item" aria-label="简介"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->简介<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/series/sdl/SAST/Semgrep/semgrep01.html" class="link series-item series-item" aria-label="01 在GitHub Actions上集成Semgrep"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->01 在GitHub Actions上集成Semgrep<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/series/sdl/SAST/Semgrep/semgrep02.html" class="router-link-active router-link-exact-active link router-link-active series-item series-item" aria-label="02 以小见大，如何改写和自定义规则"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->02 以小见大，如何改写和自定义规则<!--]--></span></span><!--[--><!--]--></a><!--]--></li></ul></section><!--]--></li></ul></section><!--]--><!--]--></aside><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">02 以小见大，如何改写和自定义规则</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Bertram<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2025-11-22<!--]--></span></span><!----><!----><!----></div><div class="theme-reco-md-content"><div><p>在我们使用Semgrep进行扫描的时候，会发现存在误报，或者有些问题它扫描不了，没有对应的规则。也就是说，根据公司和项目的风格习惯和编码规范等，我们需要对规则进行改写和自定义。</p><p>既然是写规则，那让我们先从开发安全规则角度出发，看看问题可以怎么分类：</p><ul><li><strong>特征关键词匹配</strong>。常见于不安全函数的使用</li><li><strong>通用编码问题</strong>。使用污点分析的方式跟踪输入源(source)及中间过程直到汇点(sink)，常用于命令注入、SQL注入等漏洞</li><li><strong>自研代码编码问题</strong>。属于当前系统或当前系统所对接的其他私有项目的问题，需要专门编写规则用以适配当前系统代码，常见于访问控制、不安全配置项等</li></ul><p>对于前两类问题，工具的默认规则基本上涵盖了大部分的问题识别。但是存在一个问题，就是如果我们的校验方法不是使用业界最标准的措施的话（例如自定义了一个白名单规则校验，而不是使用更安全的三方库），那么默认规则肯定是无法识别到这些自定义的校验方法的，就会导致存在误报。此时，如果这个校验方法在我们的代码里是“通用”的，很多项目中都使用到了，那么我们可以通过<strong>改写规则</strong>，加入“消毒”方法使其不会产生误报。</p><p>对于最后的自研代码编码问题，我们需要完全<strong>自定义规则</strong>。</p><p>而Semgrep作为一款扩展性强的工具，自然是可以改写和自定义规则的。下面，以SQL注入为例，分别进行规则改写和自定义编写。</p><h3 id="改写现有规则降低误报率" tabindex="-1"><a class="header-anchor" href="#改写现有规则降低误报率"><span>改写现有规则降低误报率</span></a></h3><p><code>tainted-sql-string</code>是Semgrep社区的SQL注入扫描规则，详细如下（仅保留规则核心配置，其他无关信息进行了删减），它使用污点分析模式进行匹配。</p><ul><li>pattern-sources指定了污染源是接口上用户的输入，并且将Integer、Long等类型排除在外</li><li>pattern-sinks指定了SQL拼接的情况，并将控制台输出、日志打印、抛出错误等情况进行排除</li></ul><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_unify_mvars</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                  ...</span>
<span class="line">                }</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                    $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                    ...</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += $TAINTED_KEY</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">            <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在有这样一段代码，有<code>/jdbc-bad</code>和<code>/jdbc-good</code>两个接口：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SQLiService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>sqli<span class="token punctuation">.</span></span><span class="token class-name">SQLiRequest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sqli&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.datasource.url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUrl<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.datasource.username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUsername<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.datasource.password}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbPassword<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-bad&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcBad</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 存在SQL拼接用户输入，不安全</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/jdbc-good&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">jdbcGood</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SQLiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dbUrl<span class="token punctuation">,</span> dbUsername<span class="token punctuation">,</span> dbPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM user WHERE 1=1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>conditions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> condition <span class="token operator">:</span> conditions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 检查字段名是否在User类的属性中，所以是安全的</span></span>
<span class="line">                    <span class="token function">checkFieldName</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    sql <span class="token operator">+=</span> <span class="token string">&quot; AND &quot;</span> <span class="token operator">+</span> condition<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line">                    args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">int</span> id <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">String</span> username <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;字段名不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口<code>/jdbc-bad</code>使用外部输入作为表名拼接到SQL语句中，存在SQL注入。接口<code>/jdbc-good</code>在使用外部输入作为表名拼接SQL前，调用<code>checkFieldName</code>进行了校验，因为不会存在SQL注入问题。然而，在使用<code>tainted-sql-string</code>规则进行检查时，会发现两条规则都会匹配命中。那么如果我们希望减少误报率，该怎么做呢？其实也很简单，Semgrep提供了pattern-sanitizers用于指定消毒规则。我们只需要加上如下规则即可：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">    <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>规则表示当调用<code>checkFieldName</code>对污染源进行消毒时，之后的访问都是安全的，pattern-sinks将不会触发。<code>by-side-effect</code>的作用可以参考<a href="https://semgrep.dev/docs/writing-rules/data-flow/taint-mode/advanced#taint-sanitizers-by-side-effect" target="_blank" rel="noopener noreferrer">官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，按照官方解释来说就是是否受到函数“副作用”的影响，这个所谓“副作用”指的是处理过程（如函数）是否对入参本身造成影响。简单来说就是：</p><ul><li><code>by-side-effect: false</code>（默认）：处理过程不会对输入对象造成影响，只会对返回已经“消毒”的结果。例如<code>result = sanitizers(source)</code>，source不会发生变化，还是未经消毒的输入源，而result是经过消毒、可以信任的处理数据</li><li><code>by-side-effect: only</code>：处理过程只会对输入对象进行“消毒”，不会对返回结果造成影响。例如<code>result = sanitizers(source)</code>，result不会进行消毒，但source是经过消毒的、可以信任的处理数据</li><li><code>by-side-effect: true</code>：处理过程既对输入对象“消毒”，也对返回的结果“消毒”。例如<code>result = sanitizers(source)</code>，result和source是经过消毒的，可以信任的数据</li></ul><p>就像下面这个例子：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">source <span class="token operator">=</span> userInput</span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: true</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: false</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># by-side-effect: only</span></span>
<span class="line">data <span class="token operator">=</span> sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># not ok</span></span>
<span class="line">sanitizers<span class="token punctuation">(</span>source<span class="token punctuation">)</span></span>
<span class="line">sink<span class="token punctuation">(</span>source<span class="token punctuation">)</span>  <span class="token comment"># ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，我们得到的完整规则如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string<span class="token punctuation">-</span>custom</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> ERROR</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> 自定义的spring SQL注入扫描(源自tainted<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>string)<span class="token punctuation">-</span>V1</span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cwe</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> &quot;CWE<span class="token punctuation">-</span><span class="token key atrule">89</span><span class="token punctuation">:</span> Improper Neutralization of Special Elements used in an SQL</span>
<span class="line">          Command (&#39;SQL Injection&#39;)&quot;</span>
<span class="line">      <span class="token key atrule">owasp</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> A01<span class="token punctuation">:</span>2017 <span class="token punctuation">-</span> Injection</span>
<span class="line">        <span class="token punctuation">-</span> A03<span class="token punctuation">:</span>2021 <span class="token punctuation">-</span> Injection</span>
<span class="line">      <span class="token key atrule">references</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html</span>
<span class="line">      <span class="token key atrule">category</span><span class="token punctuation">:</span> security</span>
<span class="line">      <span class="token key atrule">technology</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> spring</span>
<span class="line">      <span class="token key atrule">cwe2022-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">cwe2021-top25</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">subcategory</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> vuln</span>
<span class="line">      <span class="token key atrule">likelihood</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">      <span class="token key atrule">impact</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">confidence</span><span class="token punctuation">:</span> MEDIUM</span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">license</span><span class="token punctuation">:</span> Semgrep Rules License v1.0. For more details<span class="token punctuation">,</span> visit</span>
<span class="line">        semgrep.dev/legal/rules<span class="token punctuation">-</span>license</span>
<span class="line">      <span class="token key atrule">vulnerability_class</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> SQL Injection</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_numbers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">taint_assume_safe_booleans</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> taint</span>
<span class="line">    <span class="token key atrule">pattern-sources</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ(...) $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  $METHODNAME(..., @$REQ $TYPE $SOURCE,...) {</span>
<span class="line">                    ...</span>
<span class="line">                  }</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $REQ</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (RequestBody<span class="token punctuation">|</span>PathVariable<span class="token punctuation">|</span>RequestParam<span class="token punctuation">|</span>RequestHeader<span class="token punctuation">|</span>CookieValue)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> ^(<span class="token punctuation">?</span><span class="token tag">!(Integer</span><span class="token punctuation">|</span>Long<span class="token punctuation">|</span>Float<span class="token punctuation">|</span>Double<span class="token punctuation">|</span>Char<span class="token punctuation">|</span>Boolean<span class="token punctuation">|</span>int<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>char<span class="token punctuation">|</span>boolean))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $SOURCE</span>
<span class="line">    <span class="token key atrule">pattern-sanitizers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> checkFieldName($X.$_(<span class="token punctuation">...</span>))</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">focus-metavariable</span><span class="token punctuation">:</span> $X</span>
<span class="line">        <span class="token key atrule">by-side-effect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">pattern-sinks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot; + ...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  &quot;$SQLSTR&quot;.concat(...)</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      StringBuilder $SB = new StringBuilder(&quot;$SQLSTR&quot;);</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $SB.append(<span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> $VAR += <span class="token punctuation">...</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format(&quot;$SQLSTR&quot;<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern-inside</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                      String $VAR = &quot;$SQLSTR&quot;;</span>
<span class="line">                      ...</span></span>
<span class="line">                  <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> String.format($VAR<span class="token punctuation">,</span> <span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> System.out.println(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.info(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warn(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.warning(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debug(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.debugging(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> $LOG.error(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> new Exception(<span class="token punctuation">...</span>)</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern-not-inside</span><span class="token punctuation">:</span> throw <span class="token punctuation">...</span>;</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQLSTR</span>
<span class="line">              <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>delete<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>create<span class="token punctuation">|</span>update<span class="token punctuation">|</span>alter<span class="token punctuation">|</span>drop)\b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>扫描结果如下，位于169行的该漏洞点消失了</p><p><img src="/assets/image-20251122002415894-GSsf7cWq.png" alt="image-20251122002415894"></p><p><img src="/assets/image-20251122002517945-yPiEgG6e.png" alt="image-20251122002517945"></p><h3 id="自定义规则实现漏洞扫描" tabindex="-1"><a class="header-anchor" href="#自定义规则实现漏洞扫描"><span>自定义规则实现漏洞扫描</span></a></h3><p>Semgrep没有针对Mybatis的SQL注入校验规则，需要我们自行编写，分别用于注解方式和XML配置文件方式的情况下检测SQL注入问题。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>annotation</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using annotation</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> java</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">              $RET $METHODNAME(..., @Param(&quot;$PARAM&quot;) $TYPE $_, ...);</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., $TYPE $PARAM, ...);</span></span>
<span class="line">              <span class="token punctuation">-</span> <span class="token key atrule">pattern-not</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">                  @$OPERATION(&quot;$SQL&quot;)</span>
<span class="line">                  $RET $METHODNAME(..., @$ANNOTATION(...) $TYPE $PARAM, ...);</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $OPERATION</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(select<span class="token punctuation">|</span>insert<span class="token punctuation">|</span>update<span class="token punctuation">|</span>delete)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-regex</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $TYPE</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">?</span>i)(^(<span class="token punctuation">?</span><span class="token tag">!.*short</span><span class="token punctuation">|</span>int<span class="token punctuation">|</span>integer<span class="token punctuation">|</span>long<span class="token punctuation">|</span>float<span class="token punctuation">|</span>double<span class="token punctuation">|</span>boolean).<span class="token important">*$)</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-comparison</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">comparison</span><span class="token punctuation">:</span> str($PARAM) in str($SQL)</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $SQL</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mybatis<span class="token punctuation">-</span>sqli<span class="token punctuation">-</span>xml</span>
<span class="line">    <span class="token key atrule">message</span><span class="token punctuation">:</span> Mybatis SQL injection vulnerability using XML</span>
<span class="line">    <span class="token key atrule">severity</span><span class="token punctuation">:</span> HIGH</span>
<span class="line">    <span class="token key atrule">languages</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> xml</span>
<span class="line">    <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">interfile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">patterns</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">pattern-either</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;select&gt;$...KEY&lt;/select&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;insert&gt;$...KEY&lt;/insert&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;update&gt;$...KEY&lt;/update&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;delete&gt;$...KEY&lt;/delete&gt;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              &lt;sql&gt;$...KEY&lt;/sql&gt;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">metavariable-pattern</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">language</span><span class="token punctuation">:</span> generic</span>
<span class="line">          <span class="token key atrule">metavariable</span><span class="token punctuation">:</span> $<span class="token punctuation">...</span>KEY</span>
<span class="line">          <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token punctuation">...</span> $<span class="token punctuation">{</span>$X<span class="token punctuation">}</span> <span class="token punctuation">...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里规则写得比较简单（存在优化空间），当SQL语句注解中或者XML的SQL语句配置中出现了&quot;${...}&quot;，就认为存在SQL注入。扫描结果如下。</p><p>注解方式：</p><p><img src="/assets/image-20251121234821130-DGa_-FF_.png" alt="image-20251121234821130"></p><p>XML文件：</p><p><img src="/assets/image-20251121234728119-C_SNPRu8.png" alt="image-20251121234728119"></p><p>如果使用AppSec Platform查看，还能看到AI智能修复建议：</p><p><img src="/assets/image-20251121234615187-oQ_Jp4Rf.png" alt="image-20251121234615187"></p></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->最后更新时间 11/30/2025, 6:49:20 AM<!--]--></span></span></div></footer><nav class="page-nav"><p class="hasPrev inner"><span class="page-nav-item prev"> ← 01 在GitHub Actions上集成Semgrep</span><!----></p></nav><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/series/sdl/SAST/Semgrep/semgrep02.html#改写现有规则降低误报率" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="改写现有规则降低误报率"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->改写现有规则降低误报率<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/series/sdl/SAST/Semgrep/semgrep02.html#自定义规则实现漏洞扫描" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="自定义规则实现漏洞扫描"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->自定义规则实现漏洞扫描<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-2MiBgEQI.js" defer></script>
  </body>
</html>
